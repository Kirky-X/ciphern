name: Tag Deleted

on:
  delete:

permissions:
  contents: write

jobs:
  cleanup:
    name: Cleanup Release
    if: github.event.ref_type == 'tag'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get tag information
        id: get_tag
        run: |
          TAG_NAME="${{ github.event.ref }}"
          VERSION="${TAG_NAME#refs/tags/v}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Delete GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const { Octokit } = require('@octokit/rest');
            
            const octokit = new Octokit({
              auth: '${{ secrets.GITHUB_TOKEN }}'
            });
            
            const tag = '${{ steps.get_tag.outputs.tag_name }}';
            const owner = '${{ github.repository_owner }}';
            const repo = '${{ github.repository }}';
            
            try {
              // 查找所有匹配的 release
              const { data: releases } = await octokit.rest.repos.listReleases({
                owner,
                repo,
                per_page: 100
              });
              
              // 查找包含 tag 的 release
              const matchingReleases = releases.filter(r => 
                r.tag_name === tag || 
                (r.name && r.name.includes(tag))
              );
              
              if (matchingReleases.length > 0) {
                console.log(`Found ${matchingReleases.length} matching releases for tag ${tag}`);
                
                for (const release of matchingReleases) {
                  try {
                    await octokit.rest.repos.deleteRelease({
                      owner,
                      repo,
                      release_id: release.id
                    });
                    console.log(`✅ Deleted release: ${release.name || release.tag_name} (ID: ${release.id})`);
                  } catch (error) {
                    console.error(`❌ Failed to delete release: ${error.message}`);
                  }
                }
              } else {
                console.log(`⚠️ No release found for tag ${tag}`);
              }
              
            } catch (error) {
              console.error(`❌ Error: ${error.message}`);
              process.exit(1);
            }
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Delete tag
        if: success()
        run: |
          TAG_NAME="${{ steps.get_tag.outputs.tag_name }}"
          echo "Deleting tag: $TAG_NAME"
          
          # 使用 GitHub CLI 删除 tag
          gh tag delete "$TAG_NAME"
          echo "✅ Tag deleted successfully"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Warning about crates.io
        if: success()
        run: |
          cat << 'EOF'
          
          ⚠️ IMPORTANT: crates.io Limitation
          =====================================
          
          The version ${{ steps.get_tag.outputs.version }} will remain published.
          
          crates.io does NOT support deleting published versions.
          
          Options:
          1. Yank: version (marks it as not recommended):
             gh yank --repo ${{ github.repository }} ${{ steps.get_tag.outputs.version }} <crate-name>
          
          2. Contact crates.io support for exceptional circumstances:
             https://crates.io/policies
          
          Note: Yanking prevents new projects from depending on this version,
          but existing projects can still use it.
          
          EOF
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
